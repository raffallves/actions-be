name: Deploying lambdas separately
run-name: lemme c
on: [push]
jobs:
  Deploying-Lambdas:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Loop through SAM templates and deploy
        run: |
          for template in sam/*; do
            sam build -t "$template/template.yml"
            deploy_output=$(sam deploy -t "$template/template.yml" --no-confirm-changeset 2>&1)
            deploy_exit_code=$?

            if [[ $deploy_exit_code -eq 0 ]]; then
              echo "Deployment for $template completed successfully."
            elif echo "$deploy_output" | grep -i -q "no changes"; then
              echo "No changes detected for $template, skipping deployment."
            else
              echo "An unexpected error occurred during deployment of $template"
              echo "Error details: $deploy_output"
              exit 1
            fi
          done